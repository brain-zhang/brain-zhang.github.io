<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Linux | Living a Simple Life is a Happy Life]]></title>
  <link href="https://happy123.me/blog/categories/linux/atom.xml" rel="self"/>
  <link href="https://happy123.me/"/>
  <updated>2019-02-13T14:50:23+08:00</updated>
  <id>https://happy123.me/</id>
  <author>
    <name><![CDATA[memoryboxes]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Migrate Firewalld to Iptables on Centos7]]></title>
    <link href="https://happy123.me/blog/2017/12/06/migrate-firewalld-to-iptables-on-centos7/"/>
    <updated>2017-12-06T16:23:22+08:00</updated>
    <id>https://happy123.me/blog/2017/12/06/migrate-firewalld-to-iptables-on-centos7</id>
    <content type="html"><![CDATA[<h2>关闭 FireWall</h2>

<pre><code>systemctl stop firewalld.service #停止firewall
systemctl disable firewalld.service #禁止firewall开机启动
</code></pre>

<h2>安装 iptables</h2>

<pre><code>yum install iptables-services
</code></pre>

<!-- more -->


<h2>配置 iptables</h2>

<pre><code>#!/bin/bash

IF="eth0"

#清除规则
/sbin/iptables -F
/sbin/iptables -X
/sbin/iptables -Z

# 预定义策略
/sbin/iptables -A INPUT -s 127.0.0.1 -j ACCEPT  # 允许回环接口可以被访问
/sbin/iptables -P INPUT   DROP # 默认是拒绝访问
/sbin/iptables -P OUTPUT  ACCEPT  # 允许本机访问其他机器，无限制
/sbin/iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
/sbin/iptables -A INPUT -p icmp -j ACCEPT # 允许ping


#允许的本机服务
/sbin/iptables -A INPUT -p TCP -i $IF --dport 22 -j ACCEPT        # SSH
# /sbin/iptables -A INPUT -p TCP -i $IF --dport  3306 -j ACCEPT        # mysql
/sbin/iptables -A INPUT -p TCP -i $IF --dport  80 -j ACCEPT        # web
/sbin/iptables -A INPUT -p TCP -i $IF --dport  8888 -j ACCEPT        # web

# 黑名单
#/sbin/iptables -A INPUT -s 1.1.1.0/24 -j DROP
#/sbin/iptables -A INPUT -s 1.1.1.0 -j DROP

# 信任的网络和IP
/sbin/iptables -A INPUT -s 1.1.1.1/24 -j ACCEPT # 信任的网络

# 保存配置
/usr/libexec/iptables/iptables.init save
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Megacli Cheat]]></title>
    <link href="https://happy123.me/blog/2016/08/05/megacli-cheat/"/>
    <updated>2016-08-05T03:21:49+08:00</updated>
    <id>https://happy123.me/blog/2016/08/05/megacli-cheat</id>
    <content type="html"><![CDATA[<p>做Raid，用到了megacli，又学了一套命令.</p>

<!-- more -->


<ul>
<li>显示Rebuid进度</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -PDRbld -ShowProg -physdrv[20:2] -aALL
</code></p>

<ul>
<li>查看ES</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -PDList -aAll -NoLog | grep -Ei "(enclosure|slot)"
</code></p>

<ul>
<li>查看所有硬盘的状态</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -LDInfo -LALL -aAll
/opt/MegaRAID/MegaCli/MegaCli64 -PDList -aAll -NoLog
</code></p>

<p>如果RAID卡被设置成了writethrough。这个是完全不利用卡上内存的一种做法，操作系统需要确认磁盘全部写入后再返回，io latency很大，而且性能差。</p>

<p>可以强制让他一定使用writeback模式，命令：</p>

<p><code>
/opt/MegaCli64 -LDSetProp -ForcedWB -Immediate -Lall –aAll
</code></p>

<p>RAID卡上电池没电，单个盘损坏，都会造成RAID策略的变化，所以需要及时检测。</p>

<ul>
<li>查看所有Virtual Disk的状态</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -LdPdInfo -aAll -NoLog
</code></p>

<p>RAID Level对应关系：</p>

<pre><code>RAID Level : Primary-1, Secondary-0, RAID Level Qualifier-0 RAID 1
RAID Level : Primary-0, Secondary-0, RAID Level Qualifier-0 RAID 0
RAID Level : Primary-5, Secondary-0, RAID Level Qualifier-3 RAID 5
RAID Level : Primary-1, Secondary-3, RAID Level Qualifier-0 RAID 10
</code></pre>

<ul>
<li>在线做Raid</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdAdd -r0[0:11] WB NORA Direct CachedBadBBU -strpsz64 -a0 -NoLog
/opt/MegaRAID/MegaCli/MegaCli64 -CfgLdAdd -r5 [12:2,12:3,12:4,12:5,12:6,12:7] WB Direct -a0
</code></p>

<ul>
<li>点亮指定硬盘（定位）</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -PdLocate -start -physdrv[252:2] -a0
</code></p>

<ul>
<li>清除Foreign状态</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -CfgForeign -Clear -a0
</code></p>

<ul>
<li>查看RAID阵列中掉线的盘</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -pdgetmissing -a0
</code></p>

<ul>
<li>替换坏掉的模块</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -pdreplacemissing -physdrv[12:10] -Array5 -row0 -a0
</code></p>

<ul>
<li>手动开启rebuid</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -pdrbld -start -physdrv[12:10] -a0
</code></p>

<ul>
<li>查看Megacli的log</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -FwTermLog dsply -a0 &gt; adp2.log
</code></p>

<ul>
<li>设置HotSpare</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -pdhsp -set [-Dedicated [-Array2]] [-EnclAffinity] [-nonRevertible] -PhysDrv[4:11] -a0
/opt/MegaRAID/MegaCli/MegaCli64 -pdhsp -set [-EnclAffinity] [-nonRevertible] -PhysDrv[32：1}] -a0
</code></p>

<ul>
<li>关闭Rebuild</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -AdpAutoRbld -Dsbl -a0
</code></p>

<ul>
<li>设置rebuild的速率</li>
</ul>


<p><code>
/opt/MegaRAID/MegaCli/MegaCli64 -AdpSetProp RebuildRate -30 -a0
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Change Systemd Service Timeout Value]]></title>
    <link href="https://happy123.me/blog/2016/07/05/how-to-change-systemd-service-timeout-value/"/>
    <updated>2016-07-05T17:56:04+08:00</updated>
    <id>https://happy123.me/blog/2016/07/05/how-to-change-systemd-service-timeout-value</id>
    <content type="html"><![CDATA[<h1>show value</h1>

<p><code>
systemctl show SERVICE_NAME.service -p TimeoutStopUSec
</code></p>

<h1>change value</h1>

<p><code>
vim /usr/lib/systemd/system/node.service
</code>
TimeoutStopUSec = 900
<code>
systemctl daemon-reexec
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Migrate Centos7 From Centos6]]></title>
    <link href="https://happy123.me/blog/2015/12/22/migrate-centos7-from-centos6/"/>
    <updated>2015-12-22T11:58:43+08:00</updated>
    <id>https://happy123.me/blog/2015/12/22/migrate-centos7-from-centos6</id>
    <content type="html"><![CDATA[<p>工作环境切换到Centos7 半年有余，epel仓库里的软件版本比el6更新了不少，非常方便。</p>

<p>另外systemd的引入让很多程序，尤其是开机启动上，速度提升了不少。</p>

<p>总体来说，很多细节让你感觉很舒服，值得大家尽快切换到这个版本上了。</p>

<p>下面记一下从Centos6迁移到Centos7上 常见的Question:</p>

<h2>Q: 为什么引入systemd 代替 SysV init，我就是习惯原来的 /etc/init.d/xxxx 的方法?</h2>

<p>A: 在我看来，有两点:</p>

<ol>
<li><p> 快。 真的是快，嗖嗖的快</p></li>
<li><p> 日志。 终于能取代syslog了，我对syslog素无好感，配置复杂，level巨多，还不好排障。</p></li>
</ol>


<p>参考资料:</p>

<p><a href="http://www.ibm.com/developerworks/cn/linux/1407_liuming_init3/">http://www.ibm.com/developerworks/cn/linux/1407_liuming_init3/</a></p>

<p><a href="https://wiki.archlinux.org/index.php/Systemd">https://wiki.archlinux.org/index.php/Systemd</a></p>

<h2>Q: 为什么网卡名字这么奇怪，我要原来的简单明了的办法!!!</h2>

<p>A: 呃，好吧，我觉得虽然有一堆理由，但是网卡名字这个改变可能真的是没有产品经理的弊端。你想回到从前，很简单:</p>

<ul>
<li><p>在 grub 加入 net.ifnames=0 and biosdevname=0 作为内核参数</p></li>
<li><p>在 /etc/sysconfig/network-scripts/ 内把你的网络卡配置文件换名为 ifcfg-ethX</p></li>
<li><p>假若你拥有多个界面并希望控制每个设备的名称，不想由内核作主，你似乎有必要通过 /etc/udev/rules.d/60-net.rules 盖过 /usr/lib/udev/rules.d/60-net.rules。</p></li>
</ul>


<h2>Q: grub.cfg 文件生成怎么这个奇怪，还要先配置 /etc/default/grub，再用命令生成一遍？我要直接改!!</h2>

<p>A:  醒醒吧，我对这个改动双手赞成，至少她解决了centos6上一直被人诟病的efi问题。</p>

<h2>Q: 嗯，我想问，ifconfig和 netstat哪里去了?</h2>

<p>A: 额，套用官方原话回答吧:</p>

<p>ifconfig 及 netstat 工具程序在 CentOS 5 及 6 的应用手册内被置标为降级已接近十年，而 Redhat 决定在 CentOS 7 不会缺省安装 net-utils 组件。取而代之的工具是 ss 和 ip 。假如你真的、真的很需要 ifconfig 和 netstat，你可执行 yum install net-utils。</p>

<p>更多请参考：</p>

<p><a href="https://wiki.centos.org/zh/FAQ/CentOS7#head-d04a9f331b47791774aefd7c11371934e7350ab3">https://wiki.centos.org/zh/FAQ/CentOS7#head-d04a9f331b47791774aefd7c11371934e7350ab3</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Crontab Eight Comm]]></title>
    <link href="https://happy123.me/blog/2015/08/07/crontab-eight-comm/"/>
    <updated>2015-08-07T18:11:11+08:00</updated>
    <id>https://happy123.me/blog/2015/08/07/crontab-eight-comm</id>
    <content type="html"><![CDATA[<p>网上收集，多次踩坑，立此存照</p>

<h2>crontab八诫</h2>

<ul>
<li><p>不要假定cron知道所需要的特殊环境，它其实并不知道。所以你要保证在shelll脚本中提供所有必要的路径和环境变量，除了一些自动设置的全局变量。所以注意如下2点：</p>

<ul>
<li>脚本中涉及文件路径时写全局路径；</li>
<li><p>脚本执行要用到java或其他环境变量时，通过source命令引入环境变量，如：</p>

<pre><code>  #!/bin/sh
  source /etc/profile
  export RUN_CONF=/home/xxxx/boss.conf
  /usr/local/jboss-4.0.5/bin/run.sh -c mev &amp;
</code></pre></li>
</ul>
</li>
<li><p>当手动执行脚本OK，但是crontab死活不执行时。这时必须大胆怀疑是环境变量惹的祸，并可以尝试在crontab中直接引入环境变量解决问题。如：</p>

<pre><code>  0 * * * * . /etc/profile;/bin/sh /var/www/java/audit_no_count/bin/restart_audit.sh
</code></pre></li>
<li><p>新创建的cron job，不会马上执行，至少要过2分钟才执行。如果重启cron则马上执行。</p></li>
<li><p>每条 JOB 执行完毕之后，系统会自动将输出发送邮件给当前系统用户。日积月累，非常的多，甚至会撑爆整个系统。所以每条 JOB 命令后面进行重定向处理是非常必要的: <code>&gt;/dev/null 2&gt;&amp;1</code>, 前提是对 Job 中的命令需要正常输出已经作了一定的处理, 比如追加到某个特定日志文件。</p></li>
<li><p>当crontab突然失效时，可以尝试<code>/etc/init.d/crond restart</code>解决问题。或者查看日志看某个job有没有执行/报错 <code>tail -f /var/log/cron</code>。</p></li>
<li><p>千万别乱运行 <code>crontab -r</code>。它从Crontab目录（/var/spool/cron）中删除用户的Crontab文件。删除了该用户的所有crontab都没了。</p></li>
<li><p>在crontab中%是有特殊含义的，表示换行的意思。如果要用的话必须进行转义 <code>\%</code>，如经常用的<code>date '+%Y%m%d'</code>在crontab里是不会执行的，应该换成 <code>date '+\%Y\%m\%d'</code>。</p></li>
<li><p>永远要手工验证一下crontab中的命令</p></li>
</ul>

]]></content>
  </entry>
  
</feed>
